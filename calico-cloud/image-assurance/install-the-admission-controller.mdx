---
title: Install and configure the Admission Controller
description: Block vulnerable containers from being deployed into your cluster using the Admission Controller.
canonical_url: '/image-assurance/install-the-admission-controller'
---

>**Note**: This feature is tech preview. Tech preview features may be subject to significant changes before they become GA.
{: .alert .alert-info}

### Big picture

Protecting your cluster from vulnerable images can be very difficult. An image that appears to be secure today could 
contain a newly-discovered vulnerability tomorrow, and acting on this new information in real time can be challenging.

{{site.prodname}}â€™s Image Assurance Admission Controller automatically blocks resources that would create containers with vulnerable images from entering your cluster using the latest vulnerability data and scan results.

### Concepts

#### Kubernetes Validating Webhooks

{{site.prodname}} uses {% include open-new-window.html text='Kubernetes Validating Webhook Configuration' url='https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/' %} to register the Admission Controller as a callback to admit or deny resources that create pods, such as Deployments and
Daemonsets.

#### How the Admission Controller evaluates admission requests

The Admission Controller blocks the creation or modification of resources that create pods. If a resource that creates Pods is admitted by the Admission Controller, *the Pods it creates are not reevaluated*. For example, if you create a Deployment, the Admission Controller receives an admission request and either allows or rejects the request. If allowed, the Admission Controller will not evaluate the request for the ReplicaSet that Kubernetes creates for the Deployment or the Pod that is created for the ReplicaSet. Why? Because it could destabilize a production cluster if new vulnerabilities are found for deployed images and pods are restarted.

However, if you *create a Pod directly*, the Admission Controller evaluates the admission request for the Pod and allows or rejects the request.

#### Configure Admission Controller behavior with Container Admission Policies

Container Admission Policies are custom Kubernetes resources that allow you to configure when the Admission Controller
denies admission requests for resources that create pods.

### Install the Admission Controller

1. Create a directory to download the manifests/scripts needed for the installation.

   ```bash
   mkdir admission-controller-install && cd admission-controller-install
   ```

1. Generate the Certificate Key Pair.

   For secure TLS communication between the Kubernetes API server and the Admission controller, you must generate a TLS
   certificate and key pair.
   
   You can either generate the TLS key and certificate yourself and move them to the current folder under the names
   `admission_controller_key.pem` and `admission_controller_cert.pem`, or use the following command to generate the pair:
   ```bash
   export URL="https://storage.googleapis.com/dev-calicocloud-installer/manifests/brian-v3.12.2-1-ia-dev" && curl ${URL}/generate-open-ssl-key-cert-pair.sh | bash
   ```

   >**Note**: If you generate the key and certificate pair yourself, you must set the SANS to `tigera-image-assurance-admission-controller-service.tigera-image-assurance.svc`
   {: .alert .alert-info}

1. Download and configure the Admission Controller manifests.
   
   As a safety mechanism, we require that you specify what namespaces the Admission Controller will apply to use
   the `IN_NAMESPACE_SELECT_KEY` and the `IN_NAMESPACE_SELECTOR_VALUES`. These values configure the Kubernetes API server
   to send admission requests to our Admission Controller only for resources from relevant namespaces.

   For example, to configure the Kubernetes API server to send admission requests for resources created in any namespace
   with label key foo, and label values either bar or baz, the variables would be set as follows:
   
   ```bash
   export IN_NAMESPACE_SELECTOR_KEY="foo" && IN_NAMESPACE_SELECTOR_VALUES="bar baz"
   ```

   >**WARNING**: Do not add Kubernetes critical namespaces such as the kube-system namespace. This could create a
   deadlock situation where you cannot bring up the Admission Controller because a critical Kubernetes pod is not running,
   but you also cannot bring up the critical Kubernetes pod because the Admission Controller is not running.
   {: .alert .alert-warning}

   ```bash
   export URL="https://storage.googleapis.com/dev-calicocloud-installer/manifests/brian-v3.12.2-1-ia-dev" && \
   export IN_NAMESPACE_SELECTOR_KEY="name" && \
   export IN_NAMESPACE_SELECTOR_VALUES="default" && \
   curl ${URL}/install-ia-admission-controller.sh | bash
   ```

1. Apply the Admission Controller manifests.

   ```bash
   kubectl apply -f ./*
   ```

### Configure the Admission Controller with Container Admission Policies

Container Admission Policies can be used to define criteria in which the Admission Controller admits or denies admission 
for resources that create pods. The reference for ContainerAdmissionPolicies can be found [here]({{site.baseurl}}/reference/resources/containeradmissionpolicy).

### Troubleshooting

**My ContainerAdmissionPolicy is not blocking resources from a namespace, even though the namespaceSelector matches my namespace**

The Kubernetes API server is likely not sending admission requests for the namespace in question. Verify that the key and value(s) you specified for `IN_NAMESPACE_SELECT_KEY` and `IN_NAMESPACE_SELECT_VALUES` in the installation steps, match the policy namespaces. 
