---
description: Configure Calico to use with Layer 7 Web Application Firewall.
---

# Workload-based Web Application Firewall (WAF)

:::note

This feature is tech preview. Tech preview features may be subject to significant changes before they become GA.

:::

## Big picture

Protect cloud-native applications from application layer attacks with {{prodname}} Workload-based Web Application Firewall (WAF).

## Value

A web application firewall (WAF) protects web applications from a variety of application layer attacks such as [cross-site scripting (XSS)](https://www.f5.com/services/resources/glossary/cross-site-scripting-xss-or-css), [SQL injection](https://www.f5.com/services/resources/glossary/sql-injection), and [cookie poisoning](https://www.f5.com/services/resources/glossary/cookie-poisoning), among others. Given that attacks on apps are the [leading cause of breaches](https://www.f5.com/labs/articles/threat-intelligence/application-protection-report-2019--episode-2--2018-breach-trend), you need to protect the HTTP traffic that provides a gateway to valuable app data.

Historically, web application firewalls (WAFs) were deployed at the edge of your cluster to filter incoming traffic. Our workload-based WAF solution takes a unique, cloud-native approach to web security by allowing you to implement zero-trust rules for workloads inside your cluster.

{{prodname}} WAF allows you to selectively run service traffic within your cluster, and protect intra-cluster traffic from common HTTP-layer attacks such as SQL injection, and cross-site request forgery. To increase protection, you can use {{prodname}} network policies to enforce security controls on selected pods on the host.

In addition to protecting against application layer attacks, any blocked HTTP requests are logged and available in Elasticsearch for review. You can also create global alerts based on these logs.

## Features

This how-to-guide uses the following {{prodname}} features:

- Application Layer resource

## Concepts

### About {{prodname}} WAF

WAF is deployed in your cluster as an Envoy DaemonSet. {{prodname}} proxies selected service traffic through Envoy, checking HTTP requests using the industry-standard 
[ModSecurity module](https://owasp.org/www-project-modsecurity-core-rule-set/). To view the rule set that is bundled with WAF, see [rule-set](https://github.com/coreruleset/coreruleset/blob/v3.4/dev/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf).

You simply enable WAF in Manager UI, and determine the services that you want to enable for WAF protection. You can view WAF events as HTTP logs in Service Graph and Kibana. And you can set up global alerts to get notifications on the Alerts page. 

## Before you begin

**Not supported**
- GKE
- Windows
- eBPF dataplane

**Limitations**

WAF cannot be used with:
  - Host-networked client pods
  - TLS traffic
  - [LoadBalancer services](https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer)
  - Egress gateways
  - WireGuard on AKS or EKS (unless you apply a specific kernel variable). Contact Support for help.

:::note
When selecting and deselecting traffic for WAF, active connections may be disrupted.
:::

:::caution

Enabling WAF for certain system services may result in an undesired cluster state.
- Do not enable WAF for system service with the following prefixes:

  - `tigera-*`
  - `calico-*`
  - `kube-system`
  - `openshift-*`

- Do not enable WAF for system services with the following combination of name and namespaces:
  - name: `kubernetes`, namespace: `default`
  - name: `openshift`, namespace: `default`
  - name: `gatekeeper-webhook-service`, namespace: `gatekeeper-system`

The rules are not overridden during upgrade, you will have to manage deploying updates to the OWASP CoreRuleSet to the cluster over time. 

If you modify rules, it is recommended to keep your main version in git or similar source control systems. If you enable WAF, modify rules, and then disable WAF again then the rule modifications will be lost. 

:::

## How to

- [How WAF works](#how-waf-works)
- [Enable WAF on your cluster](#enable-waf)
- [Apply WAF to your services](#apply-waf)
- [View WAF events](#view-waf-events)
- [Fine-tuning your WAF](#fine-tuning-your-waf)
- [Disable WAF feature from your cluster](#disable-waf-feature-from-your-cluster)

### How WAF works 
You choose the traffic you want to monitor and then we proxy it through our WAF, integrated with our Envoy daemonset. No traffic will be denied by default. However, if you decide to turn blocking mode on, then the WAF uses something called [anomaly scoring mode](https://coreruleset.org/docs/concepts/anomaly_scoring/) to determine if a request is allowed with `200 OK` or denied `403 Forbidden`. 

WAF can match multiple different rules in a single HTTP request. Each rule has a score associated with it and by adding these scores together, the WAF decides to allow or deny traffic by comparing the total to the overall anomaly threshold score (100 by default). If the score is under the threshold the request is allowed and if the score is over the threshold the request is denied. Our WAF starts in detection mode only and with a high default scoring threshold so is safe to turn on and then [fine-tune the WAF](#fine-tuning-your-waf) for your specific needs in your cluster.

Every HTTP request that has a WAF finds an issue with will result in an event being created for [you to review in the UI](#view-waf-events), regardless of whether the traffic was allowed or denied. This can greatly help in tuning later.  

:::note
These are the default scoring points for each severity level, applied to each rule.

- CRITICAL severity: Anomaly Score of 5.
    Mostly generated by the application attack rules (93x and 94x files).
- ERROR severity: Anomaly Score of 4.
    Generated mostly from outbound leakage rules (95x files).
- WARNING severity: Anomaly Score of 3.
    Generated mostly by malicious client rules (91x files).
- NOTICE severity: Anomaly Score of 2.
    Generated mostly by the protocol rules (92x files).
:::

### Enable WAF

#### (Optional) Deploy a sample application
If you don’t have an application to test WAF with or don’t want to use it right away against your own application,
we recommend that you install the [GoogleCloudPlatform/microservices-demo app](https://github.com/GoogleCloudPlatform/microservices-demo):

```bash
kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/release/v0.7.0/release/kubernetes-manifests.yaml
```

#### Enable WAF using CLI

##### Enable the Policy Sync API in Felix
To enable WAF using the CLI, or you have not yet [configured L7 logs](../visibility/elastic/l7/Configure), you must enable the Policy Sync API in Felix. To do this cluster-wide,
modify the `default` FelixConfiguration to set the field `policySyncPathPrefix` to `/var/run/nodeagent`:

```bash
kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"policySyncPathPrefix":"/var/run/nodeagent"}}'
```

##### Enable WAF using kubectl

In the ApplicationLayer custom resource, named `tigera-secure`, set the `webApplicationFirewall` field to `Enabled`.

```bash
kubectl apply -f - <<EOF
apiVersion: operator.tigera.io/v1
kind: ApplicationLayer
metadata:
  name: tigera-secure
spec:
  webApplicationFirewall: Enabled
EOF
```

#### Enable WAF using the UI

On the Manager UI, click **Threat Defense**, **Web Application Firewall**, **Configure Web Application Firewall**.

 <img
    src='/img/calico-enterprise/waf-config-first-step.png'
    alt='WAF services'
    width='600'
  />

### Apply WAF to services

Now that you have deployed WAF in your cluster, you can select the services you wish to be protected from application layer attacks. 

If you have deployed the sample application, you can apply WAF on a service associated with your app, as follows:
```bash
kubectl annotate svc frontend -n default --overwrite projectcalico.org/l7-logging=true
```
Alternatively, you can use the Manager UI to apply WAF to the `frontend` service.

In this example, we applied WAF to the `frontend` service. This means that every request that goes through the `frontend` service is inspected.
However, the traffic is not blocked because the WAF rule is set to `DetectionOnly` by default. You can then begin [fine-tuning your WAF](). 

In the previous example, we applied WAF to the `frontend` service of the sample application. Here, we are
applying WAF to a service of your own application.

1. On the Manager UI, click **Threat Defense**, **Web Application Firewall**.
2. Select the services you want WAF to inspect, and then click **Confirm Selections**.
    
   <img
    src='/img/calico-enterprise/waf-select-services-3.17.png'
    alt='WAF services'
    width='600'
  />

3. On the **Web Application Firewall** page, you can verify that WAF is enabled for a service by locating the service and checking that the **Status** column says **Enabled**.

4. To make further changes to a service, click **Actions**, and then **Enable** or **Disable**.

You have now applied WAF rule sets to your own services, and note that the traffic that goes through the selected services will be alerted but not blocked by default.

#### Trigger a WAF event
If you would like to trigger a WAF event for testing purposes, you can simulate an SQL Injection attack inside your cluster by crafting a request with a query string that will trigger WAF. 

Run this curl command from any pod inside your cluster targeting a service you have selected for WAF protection above e.g. from the demo app above
```
  curl http://cartservice/cart?artist=0+div+1+union%23foo*%2F*bar%0D%0Aselect%23foo%0D%0A1%2C2%2Ccurrent_user
```

### Fine-tuning your WAF 

#### Manage your rules
The default rulesets work fine for most deployments. However, you can customize them to suit your requirements.

By default, {{prodname}} ships with CoreRuleset v3.x with the following setup files pre-loaded:

- [modsecdefault.conf](https://github.com/tigera/operator/blob/master/pkg/render/applicationlayer/modsec-core-ruleset/modsecdefault.conf)
- [crs-setup.conf](https://github.com/tigera/operator/blob/master/pkg/render/applicationlayer/modsec-core-ruleset/crs-setup.conf)
- [Ruleset files](https://github.com/tigera/operator/tree/master/pkg/render/applicationlayer/modsec-core-ruleset)

There are two ways to edit your rules. 
1. Edit the configmap in-place in your cluster using kubectl. The config map combines all the rule files together so you will need to know how to search and find the exact place in the configmap that you want to update. 

2. If you want to modify the rules in any meaningful way, it is recommended that you download the files locally and modify before replacing the configmap. In OWASP, it is recommended you disable rules or change configuration by modifying a set of specific metadata files and exclusion files, and not modify any of the main rule files directly. You can, of course, decide to replace the ruleset entirely with your own set of custom rules. This is completely fine once the rules are written in the same SecRule syntax understood by ModSecurity. We recommend you keep a version of your rule files safe in version control like git. Enabling / disabling WAF will override any changes in the ruleset with the default settings. 

To download and modify the rule files:

1. Clone our operator code which contains the ConfigMap source.

  ```bash
  git clone -depth=1 https://github.com/tigera/operator 
  ```
2. Change directory into the actual modsec ruleset files we use.

  ```bash
  cd pkg/render/applicationlayer/modsec-core-ruleset
  ```
3. Make the changes you want in the setup, conf or exclusiong files and save.
4. Create a ConfigMap.

  ```bash
  kubectl create cm --dry-run=client --from-file=. -o yaml -n tigera-operator modsecurity-ruleset > $HOME/my-tigera-waf-ruleset.yaml
  ```
5. Apply the ConfigMap to your cluster.

  ```bash
  kubectl replace -f $HOME/my-tigera-waf-ruleset.yaml
  ```

After you do these steps, the `modsecurity-ruleset` ConfigMap will be replaced in the `tigera-operator` namespace, 
which then triggers a rolling restart of your L7 pods. This means that the HTTP connections going through L7 pods at the time of pod termination will be (RST) reset. 

:::note

It is important to adhere to [CoreRuleset documentation](https://coreruleset.org/docs) on how to edit the behaviour of
 your WAF. A good place to begin at is the [CoreRuleset Quick Start](https://coreruleset.org/docs/deployment/quick_start/).

In many scenarios, the default example CRS configuration will be a good enough starting point. It is recommended to review the example configuration file before 
you deploy it to make sure it’s right for your environment.
:::


#### Set WAF rule to block traffic
By default WAF will not block a request even if it has matching rule violations. The rule engine is set to `DetectionOnly`. You can change this behaviour so that the traffic is blocked instead resulting in a HTTP response code `403 Forbidden` - if the rules triggered score over a certain threshold. 

1. Edit the configmap: 
   ```bash
   kubectl edit cm -n tigera-operator modsecurity-ruleset
   ```
2. Look for `SecRuleEngine DetectionOnly` and change it to `SecRuleEngine On`.
3. Save the changes which triggers a rolling update of the L7 pods. 

| Action | Description                                                                                                                                                             | Disruptive? |
| ------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| DetectionOnly | Traffic is not denied nor dropped. {{prodname}}  will log events. | No
| On     | Denies HTTP traffic. {{prodname}}  will log the event in Elasticsearch. | Yes          |
| Off    | Be cautious about using this option. Traffic is not denied nor alerted. |No                                                                      | Yes         |                                         

#### Change anomaly scoring threshold 

The default threshold is set to 100, a high value that is unlikely to result in blocked reuqests, even if blocking mode is enabled. This is the recommended starting point from OWASP. You are encouraged to fine-tune and lower this threshold value iteratively until you are happy with the requests being allowed and denied for your cluster. Like most default values you can find this setting in the crs-setup.conf file. You can edit directly in the configmap as follows:

:::note
The lower the anomaly scoring threshold value is, the more likely it is that traffic will be denied. 
:::

1. Edit the crs-setup.conf file: 
   ```bash
     SecAction \
      "id:900110,\
      phase:1,\
      nolog,\
      pass,\
      t:none,\
      setvar:tx.inbound_anomaly_score_threshold=100,\
      setvar:tx.outbound_anomaly_score_threshold=100"
   ```

#### Change other default settings

The CoreRuleSet has several default values and settings that you can fine-tune. Example: Rule 920420 checks the HTTP request Content-Type header against a list of allowed values. You may want to allow traffic through the WAF that has a certain Content-Type that is not allowed by default, e.g. you may have Content-Types in your micro-services workloads that are not allowed by default. Like most default values you can find the list of allowed Content-Type values in the crs-setup.conf file.

1. Edit the crs-setup.conf file and add a new Content-Type by modifying id:900220 and appending to the default list named `tx.allowed_request_content_type`

  ```bash
    # Uncomment this rule to change the default.
    #
    SecAction \
     "id:900220,\
      phase:1,\
      nolog,\
      pass,\
      t:none,\
      setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json| |application/grpc|'"
  ```

#### Disable certain rules 

You may want to disable a rule entirely. For example, if you find the allowed Content-Type rule mentioned above (rule ID 920420) too restrictive you can disable it unconditionally by changing RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example and renaming that file to remove the .example:

1. Edit RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example and add the rule ID you want to disable

  ```bash
  SecRuleRemoveById 920420
  ```
3. Rename RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example to RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf removing the *.example* in order for ModSecurity to load the file

### View WAF events

#### Threat defense

To view WAF events in a centralized security events dashboard, go to: **Threat defense**, **Security Events**. For help, see [Security Event Management](../threat/security-event-management).

#### Kibana

To view WAF events In Kibana:

1. Create the `tigera_secure_ee_waf*` index pattern. For help with index patterns, see [Kibana index pattern](../visibility/kibana).

2. Select the `tigera_secure_ee_waf*` index pattern. 


#### Disable WAF for a service

To disable WAF on a service, use the Actions menu on the WAF board, or use the following command:

```bash
kubectl annotate svc <service-name> -n <service-namespace> projectcalico.org/l7-logging-
```

### Disable WAF feature from your cluster

To disable WAF, update the [ApplicationLayer](../reference/installation/api#operator.tigera.io/v1.ApplicationLayer) resource to include the `webApplicationFirewall` field, and ensure it is set to `Disabled`.

Example:

```yaml
apiVersion: operator.tigera.io/v1
kind: ApplicationLayer
metadata:
  name: tigera-secure
spec:
  webApplicationFirewall: Disabled
```