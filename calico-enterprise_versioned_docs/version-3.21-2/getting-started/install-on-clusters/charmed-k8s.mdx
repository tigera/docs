---
description: Install Calico Enterprise on a Charmed Kubernetes cluster.
---

import InstallGeneric from '@site/calico-enterprise/_includes/components/InstallGeneric';
import Admonition from '@theme/Admonition';

# Charmed Kubernetes

## Big picture

Install $[prodname] on a Canonical Charmed Kubernetes cluster.

## Before you begin

**CNI support**

- Calico CNI for networking with $[prodname] network policy

  The geeky details of what you get by default:

  <GeekDetails
    prodname='$[prodname]'
    details='Policy:Calico,IPAM:Calico,CNI:Calico,Overlay:IPIP,Routing:BGP,Datastore:Kubernetes'
  />

:::note

By default, Charmed Kubernetes uses Calico for networking. Other CNI options like Flannel or Canal can be configured using bundle overlays during deployment.

:::

**Required**

- Your cluster meets the [system requirements](requirements.mdx)
- A [compatible Charmed Kubernetes cluster](../compatibility.mdx#charmed-kubernetes)
- A [compatible Charmed Kubernetes bundle](https://github.com/charmed-kubernetes/bundle/tree/main) configured without a CNI
- A [Tigera license key and credentials](calico-enterprise.mdx)
- [Install kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) on your workstation
- [Install juju](https://juju.is/docs/juju/install-juju) on your workstation (if managing the cluster directly)

**Deploy a compatible charmed cluster for $[prodname] using a custom bundle**

:::caution
The default Charmed Kubernetes bundle includes a managed calico charm that is unsupported to migrate to $[prodname].

For successful $[prodname] installation with Charmed Kubernetes, it is currently required to use a custom bundle file without the calico charm instead of using default Charmed Kubernetes bundle directly. This ensures proper configuration and compatibility to install $[prodname] smoothly.

:::


1. Get a local copy of the bundle file in [Charmed Kubernetes Github Releases](https://github.com/charmed-kubernetes/bundle/tree/main)

For example, to get the default bundle for the v1.33 charmed kubernetes release:

```bash
curl -o charmed-kubernetes-bundle.yaml -L https://raw.githubusercontent.com/charmed-kubernetes/bundle/refs/heads/main/releases/1.33/bundle.yaml
```

<details>
<summary>Charmed Kubernetes bundle with managed CNI (Before)</summary>

```yaml
description: A highly-available, production-grade Kubernetes cluster.
docs: https://discourse.charmhub.io/t/charmed-kubernetes-bundle/14447
issues: https://bugs.launchpad.net/charmed-kubernetes-bundles
series: noble
source: https://github.com/charmed-kubernetes/bundle
website: https://ubuntu.com/kubernetes/charmed-k8s
name: charmed-kubernetes
applications:
  calico:
    annotations:
      gui-x: '475'
      gui-y: '605'
    channel: 1.33/stable
    charm: calico
    options:
      vxlan: Always
  containerd:
    annotations:
      gui-x: '475'
      gui-y: '800'
    channel: 1.33/stable
    charm: containerd
  easyrsa:
    annotations:
      gui-x: '90'
      gui-y: '420'
    channel: 1.33/stable
    charm: easyrsa
    constraints: cores=1 mem=4G root-disk=16G
    num_units: 1
  etcd:
    annotations:
      gui-x: '800'
      gui-y: '420'
    channel: 1.33/stable
    charm: etcd
    constraints: cores=2 mem=8G root-disk=16G
    num_units: 3
    options:
      channel: 3.4/stable
  kubeapi-load-balancer:
    annotations:
      gui-x: '450'
      gui-y: '250'
    channel: 1.33/stable
    charm: kubeapi-load-balancer
    constraints: cores=1 mem=4G root-disk=16G
    expose: true
    num_units: 1
  kubernetes-control-plane:
    annotations:
      gui-x: '800'
      gui-y: '850'
    channel: 1.33/stable
    charm: kubernetes-control-plane
    constraints: cores=2 mem=8G root-disk=16G
    num_units: 2
    options:
      channel: 1.33/stable
  kubernetes-worker:
    annotations:
      gui-x: '90'
      gui-y: '850'
    channel: 1.33/stable
    charm: kubernetes-worker
    constraints: cores=2 mem=8G root-disk=16G
    expose: true
    num_units: 3
    options:
      channel: 1.33/stable
relations:
- - kubernetes-control-plane:loadbalancer-external
  - kubeapi-load-balancer:lb-consumers
- - kubernetes-control-plane:loadbalancer-internal
  - kubeapi-load-balancer:lb-consumers
- - kubernetes-control-plane:kube-control
  - kubernetes-worker:kube-control
- - kubernetes-control-plane:certificates
  - easyrsa:client
- - etcd:certificates
  - easyrsa:client
- - kubernetes-control-plane:etcd
  - etcd:db
- - kubernetes-worker:certificates
  - easyrsa:client
- - kubeapi-load-balancer:certificates
  - easyrsa:client
- - calico:etcd
  - etcd:db
- - calico:cni
  - kubernetes-control-plane:cni
- - calico:cni
  - kubernetes-worker:cni
- - containerd:containerd
  - kubernetes-worker:container-runtime
- - containerd:containerd
  - kubernetes-control-plane:container-runtime
```

</details>

Modify the bundle file in a text editor and do the following:

1. Remove the calico application from the applications section.

```
  calico:
    annotations:
      gui-x: '475'
      gui-y: '605'
    channel: 1.33/stable
    charm: calico
    options:
      vxlan: Always
```

2. Scroll down to the relations section and remove all calico relations from the relations section.


```yaml
- - calico:etcd
  - etcd:db
- - calico:cni
  - kubernetes-control-plane:cni
- - calico:cni
  - kubernetes-worker:cni
```

An example of a compatible bundle without the `calico` charm:
<details>
<summary>Charmed Kubernetes bundle without Calico CNI (After)</summary>

```yaml
description: A highly-available, production-grade Kubernetes cluster.
docs: https://discourse.charmhub.io/t/charmed-kubernetes-bundle/14447
issues: https://bugs.launchpad.net/charmed-kubernetes-bundles
series: noble
source: https://github.com/charmed-kubernetes/bundle
website: https://ubuntu.com/kubernetes/charmed-k8s
name: charmed-kubernetes
applications:
  containerd:
    annotations:
      gui-x: '475'
      gui-y: '800'
    channel: 1.33/stable
    charm: containerd
  easyrsa:
    annotations:
      gui-x: '90'
      gui-y: '420'
    channel: 1.33/stable
    charm: easyrsa
    constraints: cores=1 mem=4G root-disk=16G
    num_units: 1
  etcd:
    annotations:
      gui-x: '800'
      gui-y: '420'
    channel: 1.33/stable
    charm: etcd
    constraints: cores=2 mem=8G root-disk=16G
    num_units: 3
    options:
      channel: 3.4/stable
  kubeapi-load-balancer:
    annotations:
      gui-x: '450'
      gui-y: '250'
    channel: 1.33/stable
    charm: kubeapi-load-balancer
    constraints: cores=1 mem=4G root-disk=16G
    expose: true
    num_units: 1
  kubernetes-control-plane:
    annotations:
      gui-x: '800'
      gui-y: '850'
    channel: 1.33/stable
    charm: kubernetes-control-plane
    constraints: cores=2 mem=8G root-disk=16G
    num_units: 2
    options:
      channel: 1.33/stable
  kubernetes-worker:
    annotations:
      gui-x: '90'
      gui-y: '850'
    channel: 1.33/stable
    charm: kubernetes-worker
    constraints: cores=2 mem=8G root-disk=16G
    expose: true
    num_units: 3
    options:
      channel: 1.33/stable
relations:
- - kubernetes-control-plane:loadbalancer-external
  - kubeapi-load-balancer:lb-consumers
- - kubernetes-control-plane:loadbalancer-internal
  - kubeapi-load-balancer:lb-consumers
- - kubernetes-control-plane:kube-control
  - kubernetes-worker:kube-control
- - kubernetes-control-plane:certificates
  - easyrsa:client
- - etcd:certificates
  - easyrsa:client
- - kubernetes-control-plane:etcd
  - etcd:db
- - kubernetes-worker:certificates
  - easyrsa:client
- - kubeapi-load-balancer:certificates
  - easyrsa:client
- - calico:etcd
  - etcd:db
- - containerd:containerd
  - kubernetes-worker:container-runtime
- - containerd:containerd
  - kubernetes-control-plane:container-runtime
```

</details>

1. Configure juju with a default credential or use an existing credential that is configured with a cloud backend:
```
juju add-credential <credential-name>
```

2. Create the controller
```
juju bootstrap <controller-name> --credential <credential-name>
```

3. Create the model with a unique name
```
juju add-model <model-name>
```

4. Create the Charmed Kubernetes cluster by specifying the bundle file in the `juju deploy` command:

```
juju deploy ./charmed-kubernetes-bundle-no-calico.yaml
```

5. If you notice that the `kubernetes-control-plane` and `kubernetes-worker` are in waiting status due to missing CNI, this  can be prevented by setting `ignore-missing-cni=true` in the `kubernetes-control-plane` and `kubernetes-worker` charms by running

```bash
juju config kubernetes-control-plane ignore-missing-cni=true
juju config kubernetes-worker ignore-missing-cni=true
```

:::note
- `ignore-missing-cni=true` allows the `kubernetes-control-plane` and `kubernetes-worker` charms to be ready without waiting for a CNI plugin to be installed since $[prodname] will provide its own.
:::

6. To allow setup of the CNI to be taken care of by $[prodname], the `kubernetes-control-plane` charm also needs to allow privileged pods by running:
```bash
juju config kubernetes-control-plane allow-privileged=true
```

:::note
- `allow-privileged=true` enables privileged containers which are required to let $[prodname] setup the CNI by deploying its own calico-node daemonset
:::

7. Ensure the applications and units are active in the model by running:

```bash
juju status
```

The charmed kubernetes cluster should be healthy within a hour. 

8. Ensure the Charmed Kubernetes model and its applications are stable by running:

```bash
juju wait-for model $modelName --query='life=="alive" && status=="available"'
```

9. **Optional** - Get a copy of the kubeconfig from the `kubernetes-control-plane` application by running:
```bash
juju scp kubernetes-control-plane/0:config kubeconfig
```

## How to

1. [Install $[prodname]](#install-calico-enterprise)
1. [Install the $[prodname] license](#install-the-calico-enterprise-license)

<Admonition type='caution'>
  For Charmed Kubernetes clusters, you cannot use AWS EBS storage classes. You must configure an alternative storage solution such as local storage or another compatible storage provider.
</Admonition>

<InstallGeneric clusterType='standalone' />

## Next steps

- [Configure access to the $[prodname] web console](../../operations/cnx/access-the-manager.mdx)
- [Get started with Kubernetes network policy](../../network-policy/get-started/kubernetes-network-policy.mdx)
- [Get started with $[prodname] network policy](../../network-policy/beginners/calico-network-policy.mdx)
- [Enable default deny for Kubernetes pods](../../network-policy/beginners/kubernetes-default-deny.mdx)

**Additional resources**

- [Charmed Kubernetes documentation](https://ubuntu.com/kubernetes/charmed-k8s/docs/install-manual)
- [Charmed Kubernetes quickstart](https://ubuntu.com/kubernetes/charmed-k8s/docs/quickstart)
- [Juju documentation](https://juju.is/docs)
- [Canonical Kubernetes operations](https://ubuntu.com/kubernetes/docs)
